dist: ../dist-pach/docker

builds:
  -
    id: pachd
    dir: src/server/cmd/pachd
    main: main.go
    binary: pachd
    env:
      - CGO_ENABLED=0
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: worker
    dir: src/server/cmd/worker
    main: main.go
    binary: worker
    env:
      - CGO_ENABLED=0
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: worker_init
    dir: etc/worker
    main: init.go
    binary: worker_init
    env:
      - CGO_ENABLED=0
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: pachctl
    dir: src/server/cmd/pachctl
    main: main.go
    binary: pachctl
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
      - darwin
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"
  -
    id: pachtf
    dir: src/server/cmd/pachtf
    main: main.go
    binary: pachtf
    env:
      - CGO_ENABLED=0
    ldflags:
      - "{{ .Env.LD_FLAGS }}"
    goos:
      - linux
    goarch:
      - amd64
    gcflags:
      - "all=-trimpath={{.Env.PWD}}"

archives:
  - format: binary
    builds:
      - pachctl

checksum:
  disable: true

changelog:
  skip: true

release:
  disable: true

dockers:
  -
    image_templates:
      - pachyderm/pachd:latest
      - pachyderm/pachd:local
    use: buildx
      - "pachyderm/pachd:{{.Version}}"
    ids:
      - pachd
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.pachd
    extra_files:
      - dex-assets
      - LICENSE
      - licenses
    build_flag_templates:
      - "--label=version={{.Version}}-amd64"
      - "--label=release={{.Version}}-amd64"
      - "--platform=linux/amd64"
  -
    image_templates:
      - pachyderm/pachctl:latest
    use: buildx
    ids:
      - pachctl
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.pachctl
    build_flag_templates:
      - "--network=host"
      - "--progress=plain"
      - "--label=version={{.Version}}-amd64"
      - "--label=release={{.Version}}-amd64"
      - "--platform=linux/amd64"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/worker:latest
      - pachyderm/worker:local
    use: buildx
    ids:
      - pachctl
      - worker_init
      - worker
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.worker
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}-amd64"
      - "--label=release={{.Version}}-amd64"
      - "--platform=linux/amd64"
    extra_files:
      - LICENSE
      - licenses
  -
    image_templates:
      - pachyderm/pachtf:latest
    use: buildx
    ids:
      - pachtf
    goarch: amd64
    skip_push: false
    dockerfile: Dockerfile.pachtf
    build_flag_templates:
      - "--progress=plain"
      - "--label=version={{.Version}}-amd64"
      - "--label=release={{.Version}}-amd64"
      - "--platform=linux/amd64"
    extra_files:
      - LICENSE
      - licenses
